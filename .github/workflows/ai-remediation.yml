name: AI remediation loop
# Drive AI triage for CI failures and follow-up reviews.
on:
  issues:
    types: [opened, edited, labeled]
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  pull_request_review:
    types: [submitted]

permissions:
  issues: write
  pull-requests: write
  contents: read

env:
  CODEX_WEBHOOK_URL: ${{ secrets.CODEX_WEBHOOK_URL }}

jobs:
  prepare-ai-issue:
    name: Prep AI task from issue
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-ready')
    runs-on: ubuntu-latest
    steps:
      - name: Label issue for AI intake
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const labelsToApply = ['ai-in-progress', 'ai-task'];
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: labelsToApply,
            });

      - name: Outline AI work expectations
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue.number;
            const prHint = 'Reference this issue in the PR body so it auto-closes on merge.';
            const message = [
              'AI agent: you are clear to begin work on this issue.',
              '',
              '- Post a short plan, then open a branch to ship the fix.',
              '- Run lint and tests; paste results in a comment or use `/run-tests` if available.',
              `- ${prHint}`,
              '- When the PR is ready, apply the `ai-needs-review` label.',
              '- If a reviewer requests changes, keep the thread updated or let the workflow open a follow-up issue.',
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: message,
            });

      - name: Request Codex task pickup
        if: env.CODEX_WEBHOOK_URL != ''
        run: |
          cat >payload.json <<'PAYLOAD'
          {
            "type": "ai-issue-pickup",
            "source": "github-actions",
            "repository": "${{ github.repository }}",
            "issue": "${{ github.event.issue.number }}",
            "url": "${{ github.event.issue.html_url }}",
            "title": "${{ github.event.issue.title }}"
          }
PAYLOAD

          curl -X POST \
            -H "Content-Type: application/json" \
            --data @payload.json \
            "$CODEX_WEBHOOK_URL"

      - name: Log skipped Codex request
        if: env.CODEX_WEBHOOK_URL == ''
        run: echo "CODEX_WEBHOOK_URL not configured; relying on GitHub-native AI labels."

  tag-pr-for-ai-review:
    name: Tag PRs for AI review
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Apply ai-needs-review label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.pull_request.number;
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ['ai-needs-review'],
            });

  open-follow-up-issue:
    name: Open follow-up on AI rejection
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested'
    runs-on: ubuntu-latest
    steps:
      - name: Create follow-up issue when AI rejects
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reviewer = context.payload.review.user.login.toLowerCase();
            const aiReviewers = ['github-copilot[bot]', 'codex-bot', 'codexai[bot]'];
            const isAiReviewer = aiReviewers.includes(reviewer) || reviewer.endsWith('[bot]');
            if (!isAiReviewer) {
              core.info(`Reviewer ${reviewer} is not an AI bot; skipping follow-up issue.`);
              return;
            }

            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const title = `AI follow-up for PR #${pr.number}: ${pr.title}`;

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              labels: 'ai-follow-up,ai-ready',
            });

            const duplicate = existing.find((issue) => issue.title === title);
            if (duplicate) {
              core.info(`Follow-up issue already exists: ${duplicate.html_url}`);
              return;
            }

            const body = [
              'An AI reviewer requested changes on this PR.',
              '',
              `- PR: #${pr.number} (${pr.html_url})`,
              `- Reviewer: ${context.payload.review.user.login}`,
              `- Review: ${context.payload.review.html_url}`,
              '',
              'Please address the feedback, then re-request AI review and update labels as needed.',
            ].join('\n');

            const { data: issue } = await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['ai-follow-up', 'ai-ready'],
            });

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr.number,
              labels: ['ai-follow-up'],
            });

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body: `Opened follow-up issue ${issue.html_url} after AI requested changes.`,
            });
