# Main CI workflow - orchestrates all CI checks
name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:


jobs:
  ci-tasks:
    name: CI Tasks
    uses: ./.github/workflows/ci-tasks.yml
    with:
      bun-version: '1.3.4'

  e2e-tasks:
    name: E2E Tasks
    uses: ./.github/workflows/e2e-tasks.yml
    with:
      bun-version: '1.3.4'

  create-test-failure-issue:
    name: Create issue on CI failure
    runs-on: ubuntu-latest
    needs: [ci-tasks, e2e-tasks]
    if: ${{ always() }}
    permissions:
      issues: write
      contents: read

    steps:
      - name: Create AI-routed issue for CI failures
        if: ${{ needs.ci-tasks.result == 'failure' || needs.e2e-tasks.result == 'failure' }}
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const title = `Fix CI failure (lint + tests) for run #${context.runNumber}`;

            // Labels for AI routing and categorization
            const labels = [
              'ci-failure',
              'lint',
              'tests',
              'ai',
              'ai-review',
              'ai-fix-candidate'
            ];

            // Check for duplicate issues
            const existing = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'open', per_page: 100 }
            );

            const duplicate = existing.find(i => i.title === title);
            if (duplicate) {
              core.info(`Issue already exists: ${duplicate.html_url}`);
              return;
            }

            // Build issue body with clear structure
            const body = [
              'ðŸš¨ **Automated CI Alert**',
              '',
              'Both **lint** and **tests** failed in the same CI run.',
              '',
              `- Run: [#${context.runNumber}](${runUrl})`,
              `- Commit: ${context.sha}`,
              `- Branch: ${context.ref_name ?? context.ref ?? 'unknown'}`,
              '',
              '### AI Notes',
              '- This issue is explicitly marked as **AI-actionable**.',
              '- An AI agent may:',
              '  - Fix lint errors automatically',
              '  - Repair failing unit or Playwright tests',
              '  - Open a PR referencing this issue for auto-close',
              '',
              '### Human Fallback',
              '- Review the failure if AI-generated PR is incorrect',
              '- Merge once green',
            ].join('\n');

            // Create the issue
            const { data: issue } = await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels,
            });

            core.info(`Created issue: ${issue.html_url}`);

            // Add AI tasking comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: [
                'ðŸ¤– **AI TASKING COMMENT**',
                '',
                'You are authorized to act on this issue.',
                '',
                'Suggested workflow:',
                '1. Inspect CI logs for lint + test failures',
                '2. Apply minimal fixes',
                '3. Open a PR referencing this issue number',
                '',
                'Labels on this issue indicate AI-safe automation.',
              ].join('\n'),
            });
