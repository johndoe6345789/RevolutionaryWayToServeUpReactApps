name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: Lint and format check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install codegen dependencies
        run: bun install
        working-directory: codegen

      - name: Install retro-react-app dependencies
        run: bun install
        working-directory: retro-react-app

      - name: Install e2e dependencies
        run: bun install
        working-directory: e2e

      - name: Run comprehensive linting
        run: node scripts/lint-all.js

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install codegen dependencies
        run: bun install
        working-directory: codegen

      - name: Run codegen unit tests
        run: npm test
        working-directory: codegen

  smoke-test:
    name: Playwright smoke test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # NOTE: do NOT "needs: lint" if you want the issue to be created only when
    # BOTH lint and tests fail in the same run. They must run independently.
    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Install retro-react-app dependencies
        run: bun install
        working-directory: retro-react-app

      - name: Install e2e dependencies
        run: bun install
        working-directory: e2e

      - name: Verify Playwright browsers exist
        working-directory: e2e
        run: |
          test -d "$HOME/.cache/ms-playwright" || echo "Browsers will be installed by postinstall hook"
          bun x playwright --version

      - name: Run Playwright smoke test
        run: bun run test
        working-directory: e2e

  create-test-failure-issue:
    name: Open issue when BOTH lint and tests fail
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, smoke-test]
    if: ${{ always() }}
    permissions:
      issues: write
      contents: read

    steps:
      - name: Create issue for failing lint+tests (AI-routed)
        if: ${{ needs.lint.result == 'failure' && (needs.unit-tests.result == 'failure' || needs.smoke-test.result == 'failure') }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const title = `Fix CI failure (lint + tests) for run #${context.runNumber}`;

            // AI + CI routing labels
            const labels = [
              'ci-failure',
              'lint',
              'tests',
              'ai',
              'ai-review',
              'ai-fix-candidate'
            ];

            // Optional: real human maintainers only (bots cannot be assigned)
            const desiredAssignees = [
              // 'johndoe6345789'
            ];

            // De-dupe by exact title
            const existing = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'open', per_page: 100 }
            );

            const dup = existing.find(i => i.title === title);
            if (dup) {
              core.info(`Issue already exists: ${dup.html_url}`);
              return;
            }

            const body = [
              'ğŸš¨ **Automated CI Alert**',
              '',
              'Both **lint** and **tests** failed in the same CI run.',
              '',
              `- Run: [#${context.runNumber}](${runUrl})`,
              `- Commit: ${context.sha}`,
              `- Branch: ${context.ref_name ?? context.ref ?? 'unknown'}`,
              '',
              '### AI notes',
              '- This issue is explicitly marked as **AI-actionable**.',
              '- An AI agent may:',
              '  - Fix lint errors automatically',
              '  - Repair failing unit or Playwright tests',
              '  - Open a PR referencing this issue for auto-close',
              '',
              '### Human fallback',
              '- Review the failure if AI-generated PR is incorrect',
              '- Merge once green',
            ].join('\n');

            async function filterValidAssignees(logins) {
              const out = [];
              for (const login of logins) {
                try {
                  await github.rest.issues.checkUserCanBeAssigned({
                    owner,
                    repo,
                    assignee: login,
                  });
                  out.push(login);
                } catch (e) {
                  core.warning(
                    `Skipping invalid/unassignable assignee "${login}": ` +
                    `${e.status ?? ''} ${e.message ?? e}`
                  );
                }
              }
              return out;
            }

            const assignees = await filterValidAssignees(desiredAssignees);

            // Create issue first (never include assignees here to avoid 422)
            const { data: issue } = await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels,
            });

            core.info(`Created issue: ${issue.html_url}`);

            // Add explicit AI-directed comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: [
                'ğŸ¤– **AI TASKING COMMENT**',
                '',
                'You are authorized to act on this issue.',
                '',
                'Suggested workflow:',
                '1. Inspect CI logs for lint + test failures',
                '2. Apply minimal fixes',
                '3. Open a PR referencing this issue number',
                '',
                'Labels on this issue indicate AI-safe automation.',
              ].join('\n'),
            });

            // Best-effort assignment (humans only)
            if (assignees.length > 0) {
              try {
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: issue.number,
                  assignees,
                });
                core.info(`Assigned: ${assignees.join(', ')}`);
              } catch (e) {
                core.warning(
                  `Issue created but assignment failed: ` +
                  `${e.status ?? ''} ${e.message ?? e}`
                );
              }
            }
