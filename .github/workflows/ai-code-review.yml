name: AI code review requests

# This workflow uses pull_request_target to have write permissions for posting
# comments and accessing the CODEX_WEBHOOK_URL secret. This is safe because:
# - It only reads public PR metadata (doesn't check out PR code)
# - It only posts standard comment messages
# - The webhook receives PR metadata, not repository secrets
#
# Security note: Depending on repository settings, this workflow may run on
# fork pull requests without requiring manual approval. It is designed to be
# safe in that mode since it performs only safe, read-only operations with
# controlled outputs.

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, closed]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  request-ai-reviews:
    name: Request Codex and Copilot reviews
    runs-on: ubuntu-latest
    env:
      CODEX_WEBHOOK_URL: ${{ secrets.CODEX_WEBHOOK_URL }}
    steps:
      - name: Ask Copilot for a code review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {owner, repo} = context.repo;
            const number = context.payload.pull_request.number;
            const state = context.payload.pull_request.state;

            const body = [
              '@copilot Please provide a code review for this pull request.',
              '',
              `PR state: ${state}.`,
              'Review even if the pull request is closed so notes are captured for posterity.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body,
            });

      - name: Request Codex code review
        if: env.CODEX_WEBHOOK_URL != ''
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_STATE: ${{ github.event.pull_request.state }}
          REPO: ${{ github.repository }}
          PR_HTML_URL: ${{ github.event.pull_request.html_url }}
        run: |
          set -euo pipefail

          python - <<'PY'
          import json
          import os

          payload = {
              "type": "ai-code-review",
              "repository": os.environ["REPO"],
              "pullRequest": int(os.environ["PR_NUMBER"]),
              "title": os.environ["PR_TITLE"],
              "state": os.environ["PR_STATE"],
              "url": os.environ["PR_HTML_URL"],
              "message": "Request a Codex code review for this pull request, even if it is closed.",
          }

          with open("payload.json", "w", encoding="utf-8") as f:
              json.dump(payload, f)
          PY

          curl -X POST \
            -H "Content-Type: application/json" \
            --data @payload.json \
            "$CODEX_WEBHOOK_URL"

      - name: Log missing Codex webhook
        if: env.CODEX_WEBHOOK_URL == ''
        run: echo "CODEX_WEBHOOK_URL not configured; skipping Codex review request."
