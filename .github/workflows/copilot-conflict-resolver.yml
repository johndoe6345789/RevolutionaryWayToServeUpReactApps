# Automated merge conflict resolution workflow
name: Copilot Conflict Resolver

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write   # comment + label
  issues: write          # PR comments are "issues" in the API
  contents: read

jobs:
  request-copilot-conflict-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Detect merge conflicts
        id: detect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          # Only request Copilot when the PR branch is in this repository (avoid forks)
          head_repo="$(gh api repos/$REPO/pulls/$PR_NUMBER --jq '.head.repo.full_name')"
          base_repo="$(gh api repos/$REPO/pulls/$PR_NUMBER --jq '.base.repo.full_name')"

          if [ "$head_repo" != "$base_repo" ]; then
            echo "copilot_allowed=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=forked_pull_request" >> "$GITHUB_OUTPUT"
          else
            echo "copilot_allowed=true" >> "$GITHUB_OUTPUT"
            echo "skip_reason=" >> "$GITHUB_OUTPUT"
          fi

          # Wait for mergeable_state to be computed (can be "unknown" briefly)
          state="unknown"
          for i in 1 2 3 4 5 6; do
            state="$(gh api repos/$REPO/pulls/$PR_NUMBER --jq '.mergeable_state // "unknown"')"
            echo "Attempt $i: mergeable_state=$state"

            if [ "$state" != "unknown" ]; then
              break
            fi
            sleep 5
          done

          echo "mergeable_state=$state" >> "$GITHUB_OUTPUT"

          if [ "$state" = "dirty" ]; then
            echo "has_conflicts=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_conflicts=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Apply conflict label
        if: steps.detect.outputs.copilot_allowed == 'true' && steps.detect.outputs.has_conflicts == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          gh api -X POST "repos/$REPO/issues/$PR_NUMBER/labels" \
            -f "labels[]=copilot/conflict-fix-requested" >/dev/null || true

      - name: Request Copilot conflict resolution
        if: steps.detect.outputs.copilot_allowed == 'true' && steps.detect.outputs.has_conflicts == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          body=$(cat <<'BODY'
          @copilot Please resolve the merge conflicts in this pull request.

          Requirements:
          - Merge the base branch into this PR branch and resolve conflicts correctly (do not drop changes).
          - Prefer minimal, correct resolutions; preserve intended behavior.
          - Run the repositoryâ€™s tests/linters if available and fix any failures introduced by the merge resolution.
          - Open a new pull request with the conflict resolution on top of this PR, targeting the same base branch.
          BODY
          )

          gh api -X POST "repos/$REPO/issues/$PR_NUMBER/comments" \
            -f "body=$body" >/dev/null
