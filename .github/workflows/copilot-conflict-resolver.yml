name: Copilot conflict resolver

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write   # comment + label
  issues: write          # PR comments are "issues" in the API
  contents: read

jobs:
  request-copilot-conflict-fix:
    runs-on: ubuntu-latest
    env:
      CODEX_WEBHOOK_URL: ${{ secrets.CODEX_WEBHOOK_URL }}
    steps:
      - name: Decide whether PR has merge conflicts
        id: detect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          # Only request Copilot when the PR branch is in this repository (avoid forks with pull_request_target).
          head_repo="$(gh api repos/$REPO/pulls/$PR_NUMBER --jq '.head.repo.full_name')"
          base_repo="$(gh api repos/$REPO/pulls/$PR_NUMBER --jq '.base.repo.full_name')"
          if [ "$head_repo" != "$base_repo" ]; then
            echo "copilot_allowed=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=forked_pull_request" >> "$GITHUB_OUTPUT"
          else
            echo "copilot_allowed=true" >> "$GITHUB_OUTPUT"
            echo "skip_reason=" >> "$GITHUB_OUTPUT"
          fi

          # mergeable_state can be "unknown" briefly; retry.
          state="unknown"
          for i in 1 2 3 4 5 6; do
            state="$(gh api repos/$REPO/pulls/$PR_NUMBER --jq '.mergeable_state // "unknown"')"
            echo "Attempt $i: mergeable_state=$state"
            if [ "$state" != "unknown" ]; then
              break
            fi
            sleep 5
          done

          echo "mergeable_state=$state" >> "$GITHUB_OUTPUT"
          if [ "$state" = "dirty" ]; then
            echo "has_conflicts=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_conflicts=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Add label (optional)
        if: steps.detect.outputs.copilot_allowed == 'true' && steps.detect.outputs.has_conflicts == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail
          gh api -X POST "repos/$REPO/issues/$PR_NUMBER/labels" \
            -f "labels[]=copilot/conflict-fix-requested" >/dev/null || true

      - name: Ask Copilot to resolve conflicts and open a new PR
        if: steps.detect.outputs.copilot_allowed == 'true' && steps.detect.outputs.has_conflicts == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          body=$(cat <<'BODY'
          @copilot Please resolve the merge conflicts in this pull request.

          Requirements:
          - Merge the base branch into this PR branch and resolve conflicts correctly (do not drop changes).
          - Prefer minimal, correct resolutions; preserve intended behavior.
          - Run the repositoryâ€™s tests/linters if available and fix any failures introduced by the merge resolution.
          - Open a new pull request with the conflict resolution on top of this PR, targeting the same base branch.
          BODY
          )

          gh api -X POST "repos/$REPO/issues/$PR_NUMBER/comments" \
            -f "body=$body" >/dev/null

      - name: Explain why Copilot was not requested
        if: steps.detect.outputs.has_conflicts == 'true' && steps.detect.outputs.copilot_allowed != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SKIP_REASON: ${{ steps.detect.outputs.skip_reason }}
        run: |
          set -euo pipefail

          reason_message="Copilot conflict resolution was skipped."
          if [ -n "$SKIP_REASON" ]; then
            reason_message+=" Reason: $SKIP_REASON."
          fi

          body=$(cat <<BODY
          $reason_message

          We detected merge conflicts but avoided auto-requesting Copilot. A Codex request will be sent if a webhook is configured.
          BODY
          )

          gh api -X POST "repos/$REPO/issues/$PR_NUMBER/comments" \
            -f "body=$body" >/dev/null

      - name: Request Codex help as fallback
        if: steps.detect.outputs.has_conflicts == 'true' && steps.detect.outputs.copilot_allowed != 'true' && env.CODEX_WEBHOOK_URL != ''
        env:
          CODEX_WEBHOOK_URL: ${{ secrets.CODEX_WEBHOOK_URL }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -euo pipefail

          cat >payload.json <<EOF
          {
            "type": "merge-conflict-resolution",
            "repository": "$REPO",
            "pullRequest": $PR_NUMBER,
            "base": "$BASE_REF",
            "head": "$HEAD_REF",
            "message": "Copilot conflict resolution was skipped; request Codex to prepare a merge-conflict fix."
          }
          EOF

          curl -X POST \
            -H "Content-Type: application/json" \
            --data @payload.json \
            "$CODEX_WEBHOOK_URL"

